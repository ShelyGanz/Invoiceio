<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Invoice Manager Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div id="loading-screen">
            <h1>Loading...</h1>
        </div>
        
        <div id="main-screen" class="hidden">
            <h1>Invoice Manager</h1>
            <div id="user-info"></div>
            
            <div class="income-summary">
                <h3>Total Income</h3>
                <div id="total-income" class="income-value">$0.00</div>
            </div>
            
            <h2>Invoices</h2>
            <div class="status-filter">
                <button class="active" data-status="all">All</button>
                <button data-status="unpaid">Unpaid</button>
                <button data-status="draft">Draft</button>
            </div>
            <button id="create-invoice-button" class="button">Create New Invoice</button>
            <table id="invoice-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Number</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="invoice-list"></tbody>
            </table>
        </div>
        
        <div id="invoice-form" class="hidden invoice-form">
            <button id="back-button" class="back-button">&#8592;</button>
            <h2>Create New Invoice</h2>
            <form id="new-invoice-form">
                <div class="form-group">
                    <label for="business-details">Business Details</label>
                    <textarea id="business-details" rows="3" placeholder="Your business details"></textarea>
                </div>
                <div class="form-group">
                    <label for="invoice-title">Invoice Title</label>
                    <input type="text" id="invoice-title" placeholder="Invoice" required>
                </div>
                <div class="form-group">
                    <label for="invoice-summary">Summary</label>
                    <input type="text" id="invoice-summary" placeholder="Invoice summary">
                </div>
                <div class="form-group logo-upload">
                    <label for="logo-upload">Logo</label>
                    <div id="logo-upload-area">
                        <p>Tap to upload logo</p>
                        <p>Max 5MB (JPG, PNG, GIF)</p>
                    </div>
                    <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                </div>
                <div class="form-group">
                    <label for="invoice-number">Invoice Number</label>
                    <input type="text" id="invoice-number" required>
                </div>
                <div class="form-group">
                    <label for="po-number">P.O./S.O. Number</label>
                    <input type="text" id="po-number">
                </div>
                <div class="form-group">
                    <label for="invoice-date">Invoice Date</label>
                    <input type="date" id="invoice-date" required>
                </div>
                <div class="form-group">
                    <label for="payment-due">Payment Due</label>
                    <input type="date" id="payment-due" required>
                </div>
                <div class="form-group">
                    <label for="customer-details">Customer Details</label>
                    <textarea id="customer-details" rows="3" placeholder="Customer details"></textarea>
                </div>
                <h3>Items</h3>
                <table id="items-table" class="items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="item-rows">
                        <!-- Item rows will be added here dynamically -->
                    </tbody>
                </table>
                <button type="button" id="add-item" class="add-item-btn">Add Item</button>
                <div class="form-group">
                    <label for="subtotal">Subtotal</label>
                    <input type="text" id="subtotal" readonly>
                </div>
                <button type="button" id="add-discount" class="add-discount-btn">Add Discount</button>
                <div class="form-group">
                    <label for="total">Total</label>
                    <input type="text" id="total" readonly>
                </div>
                <div class="form-group">
                    <label for="currency">Currency</label>
                    <select id="currency">
                        <option value="CAD">CAD ($)</option>
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (â‚¬)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="notes">Notes / Terms</label>
                    <textarea id="notes" rows="3" placeholder="Additional notes or terms"></textarea>
                </div>
                <div class="form-group">
                    <label for="footer">Footer</label>
                    <textarea id="footer" rows="2" placeholder="Invoice footer"></textarea>
                </div>
                <button type="submit" class="button">Save Invoice</button>
            </form>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        Telegram.WebApp.ready();

        const loadingScreen = document.getElementById('loading-screen');
        const mainScreen = document.getElementById('main-screen');
        const invoiceForm = document.getElementById('invoice-form');
        const userInfo = document.getElementById('user-info');
        const createInvoiceButton = document.getElementById('create-invoice-button');
        const newInvoiceForm = document.getElementById('new-invoice-form');
        const invoiceList = document.getElementById('invoice-list');
        const statusFilters = document.querySelectorAll('.status-filter button');
        const backButton = document.getElementById('back-button');

        let user = null;
        let invoices = [];

        // Automatic user authorization
        function authorizeUser() {
            if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                user = {
                    id: Telegram.WebApp.initDataUnsafe.user.id,
                    name: Telegram.WebApp.initDataUnsafe.user.first_name,
                    username: Telegram.WebApp.initDataUnsafe.user.username,
                    photo: Telegram.WebApp.initDataUnsafe.user.photo_url
                };
                
                if (user.id) {
                    loadingScreen.classList.add('hidden');
                    mainScreen.classList.remove('hidden');
                    userInfo.innerHTML = `Welcome, ${user.name}!`;
                    loadInvoices();
                    updateIncomeSummary();
                } else {
                    alert('Authorization failed. Please try again.');
                }
            } else {
                alert('Unable to retrieve user data. Please make sure you\'re opening this app from Telegram.');
            }
        }

        // Call authorize function when the app is ready
        Telegram.WebApp.onEvent('mainButtonClicked', authorizeUser);
        
        // Automatically try to authorize when the page loads
        window.addEventListener('load', authorizeUser);

        // Create new invoice
        createInvoiceButton.addEventListener('click', () => {
            mainScreen.classList.add('hidden');
            invoiceForm.classList.remove('hidden');
            document.getElementById('invoice-number').value = invoices.length + 1;
            document.getElementById('invoice-date').valueAsDate = new Date();
            document.getElementById('payment-due').valueAsDate = new Date();
        });

        // Add event listener for back button
        backButton.addEventListener('click', () => {
            invoiceForm.classList.add('hidden');
            mainScreen.classList.remove('hidden');
        });

        // Handle new invoice form submission
        newInvoiceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newInvoice = {
                id: Date.now(),
                businessDetails: document.getElementById('business-details').value,
                title: document.getElementById('invoice-title').value,
                summary: document.getElementById('invoice-summary').value,
                number: document.getElementById('invoice-number').value,
                poNumber: document.getElementById('po-number').value,
                date: document.getElementById('invoice-date').value,
                paymentDue: document.getElementById('payment-due').value,
                customerDetails: document.getElementById('customer-details').value,
                items: getItemsFromTable(),
                subtotal: document.getElementById('subtotal').value,
                total: document.getElementById('total').value,
                currency: document.getElementById('currency').value,
                notes: document.getElementById('notes').value,
                footer: document.getElementById('footer').value,
                status: 'draft'
            };
            invoices.push(newInvoice);
            saveInvoices();
            renderInvoices();
            updateIncomeSummary();
            invoiceForm.classList.add('hidden');
            mainScreen.classList.remove('hidden');
            newInvoiceForm.reset();
            
            // Show popup notification
            Telegram.WebApp.showPopup({
                title: 'Invoice Created',
                message: `Invoice #${newInvoice.number} has been created successfully.`,
                buttons: [{type: 'ok'}]
            });
        });

        function loadInvoices() {
            const savedInvoices = localStorage.getItem(`invoices_${user.id}`);
            if (savedInvoices) {
                invoices = JSON.parse(savedInvoices);
                renderInvoices();
            }
        }

        function saveInvoices() {
            localStorage.setItem(`invoices_${user.id}`, JSON.stringify(invoices));
        }

        function renderInvoices(filter = 'all') {
            invoiceList.innerHTML = '';
            invoices.forEach(invoice => {
                if (filter === 'all' || invoice.status === filter) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="status-indicator status-${invoice.status}">${invoice.status}</span></td>
                        <td>${new Date(invoice.date).toLocaleDateString()}</td>
                        <td>${invoice.number}</td>
                        <td>${invoice.currency} ${invoice.total}</td>
                        <td>
                            <button onclick="viewInvoiceDetails(${invoice.id})" class="button">View</button>
                        </td>
                    `;
                    invoiceList.appendChild(tr);
                }
            });
            updateIncomeSummary();
        }

        function viewInvoiceDetails(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                mainScreen.classList.add('hidden');
                const detailsScreen = document.createElement('div');
                detailsScreen.id = 'invoice-details';
                detailsScreen.innerHTML = `
                    <button class="back-button" onclick="closeInvoiceDetails()">&#8592;</button>
                    <h2>Invoice ${invoice.number}</h2>
                    <p>Status: <span class="status-indicator status-${invoice.status}">${invoice.status}</span></p>
                    <p>Date: ${new Date(invoice.date).toLocaleDateString()}</p>
                    <p>Customer: ${invoice.customerDetails}</p>
                    <p>Total: ${invoice.currency} ${invoice.total}</p>
                    <h3>Items</h3>
                    <ul>
                        ${invoice.items.map(item => `<li>${item.description} - ${item.quantity} x ${item.price} = ${item.amount}</li>`).join('')}
                    </ul>
                    <button onclick="confirmDeleteInvoice(${invoice.id})" class="delete-button">Delete Invoice</button>
                    <button onclick="previewInvoice(${invoice.id})" class="preview-button">Preview Invoice</button>
                `;
                document.body.appendChild(detailsScreen);
            }
        }

        function confirmDeleteInvoice(id) {
            Telegram.WebApp.showConfirm(
                "Are you sure you want to delete this invoice?",
                (confirmed) => {
                    if (confirmed) {
                        deleteInvoice(id);
                    }
                }
            );
        }

        function closeInvoiceDetails() {
            const detailsScreen = document.getElementById('invoice-details');
            if (detailsScreen) {
                detailsScreen.remove();
            }
            mainScreen.classList.remove('hidden');
        }

        function deleteInvoice(id) {
            invoices = invoices.filter(inv => inv.id !== id);
            saveInvoices();
            renderInvoices();
            updateIncomeSummary();
            closeInvoiceDetails();
            mainScreen.classList.remove('hidden');
            
            // Show a notification that the invoice was deleted
            Telegram.WebApp.showPopup({
                title: 'Invoice Deleted',
                message: 'The invoice has been successfully deleted.',
                buttons: [{type: 'ok'}]
            });
        }

        function previewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                const previewScreen = document.createElement('div');
                previewScreen.id = 'invoice-preview';
                previewScreen.innerHTML = `
                    <button class="back-button" onclick="closePreview()">&#8592;</button>
                    <h2>Invoice Preview</h2>
                    <div class="preview-toggle">
                        <button class="active" onclick="togglePreview('mobile')">Mobile</button>
                        <button onclick="togglePreview('desktop')">Desktop</button>
                    </div>
                    <div class="preview-container">
                        <img src="/api/placeholder/300/500" alt="Invoice Preview" id="preview-image">
                    </div>
                `;
                document.body.appendChild(previewScreen);
            }
        }

        function closePreview() {
            const previewScreen = document.getElementById('invoice-preview');
            if (previewScreen) {
                previewScreen.remove();
            }
        }

        function togglePreview(type) {
            const buttons = document.querySelectorAll('.preview-toggle button');
            buttons.forEach(button => button.classList.remove('active'));
            event.target.classList.add('active');
            // In a real implementation, you would update the preview image here
            // For this example, we'll just use a placeholder
            document.getElementById('preview-image').src = `/api/placeholder/${type === 'mobile' ? '300/500' : '600/800'}`;
        }

        function updateIncomeSummary() {
            const totalIncome = invoices
                .filter(invoice => invoice.status === 'paid')
                .reduce((sum, invoice) => sum + parseFloat(invoice.total), 0);
            
            document.getElementById('total-income').textContent = `$${totalIncome.toFixed(2)}`;
        }

        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                alert(`Invoice Details:\nTitle: ${invoice.title}\nCustomer: ${invoice.customerDetails}\nTotal: ${invoice.currency} ${invoice.total}\nStatus: ${invoice.status}\nDate: ${new Date(invoice.date).toLocaleDateString()}`);
            }
        }

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                document.getElementById('business-details').value = invoice.businessDetails;
                document.getElementById('invoice-title').value = invoice.title;
                document.getElementById('invoice-summary').value = invoice.summary;
                document.getElementById('invoice-number').value = invoice.number;
                document.getElementById('po-number').value = invoice.poNumber;
                document.getElementById('invoice-date').value = invoice.date;
                document.getElementById('payment-due').value = invoice.paymentDue;
                document.getElementById('customer-details').value = invoice.customerDetails;
                document.getElementById('subtotal').value = invoice.subtotal;
                document.getElementById('total').value = invoice.total;
                document.getElementById('currency').value = invoice.currency;
                document.getElementById('notes').value = invoice.notes;
                document.getElementById('footer').value = invoice.footer;

                // Populate items table
                const itemRows = document.getElementById('item-rows');
                itemRows.innerHTML = '';
                invoice.items.forEach(item => addItemRow(item));

                mainScreen.classList.add('hidden');
                invoiceForm.classList.remove('hidden');

                // Change form submission behavior for editing
                newInvoiceForm.onsubmit = (e) => {
                    e.preventDefault();
                    updateInvoice(id);
                };
            }
        }

        function updateInvoice(id) {
            const updatedInvoice = {
                id: id,
                businessDetails: document.getElementById('business-details').value,
                title: document.getElementById('invoice-title').value,
                summary: document.getElementById('invoice-summary').value,
                number: document.getElementById('invoice-number').value,
                poNumber: document.getElementById('po-number').value,
                date: document.getElementById('invoice-date').value,
                paymentDue: document.getElementById('payment-due').value,
                customerDetails: document.getElementById('customer-details').value,
                items: getItemsFromTable(),
                subtotal: document.getElementById('subtotal').value,
                total: document.getElementById('total').value,
                currency: document.getElementById('currency').value,
                notes: document.getElementById('notes').value,
                footer: document.getElementById('footer').value,
                status: 'draft' // You might want to add a status field in the form
            };

            const index = invoices.findIndex(inv => inv.id === id);
            if (index !== -1) {
                invoices[index] = updatedInvoice;
                saveInvoices();
                renderInvoices();
                updateIncomeSummary();
                invoiceForm.classList.add('hidden');
                mainScreen.classList.remove('hidden');
                newInvoiceForm.reset();

                // Reset form submission behavior
                newInvoiceForm.onsubmit = (e) => {
                    e.preventDefault();
                    // Original new invoice creation logic
                    const newInvoice = {
                        id: Date.now(),
                        businessDetails: document.getElementById('business-details').value,
                        title: document.getElementById('invoice-title').value,
                        summary: document.getElementById('invoice-summary').value,
                        number: document.getElementById('invoice-number').value,
                        poNumber: document.getElementById('po-number').value,
                        date: document.getElementById('invoice-date').value,
                        paymentDue: document.getElementById('payment-due').value,
                        customerDetails: document.getElementById('customer-details').value,
                        items: getItemsFromTable(),
                        subtotal: document.getElementById('subtotal').value,
                        total: document.getElementById('total').value,
                        currency: document.getElementById('currency').value,
                        notes: document.getElementById('notes').value,
                        footer: document.getElementById('footer').value,
                        status: 'draft'
                    };
                    invoices.push(newInvoice);
                    saveInvoices();
                    renderInvoices();
                    updateIncomeSummary();
                    invoiceForm.classList.add('hidden');
                    mainScreen.classList.remove('hidden');
                    newInvoiceForm.reset();
                };
            }
        }

        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                invoices = invoices.filter(inv => inv.id !== id);
                saveInvoices();
                renderInvoices();
                updateIncomeSummary();
            }
        }

        function getItemsFromTable() {
            const items = [];
            const rows = document.querySelectorAll('#item-rows tr');
            rows.forEach(row => {
                items.push({
                    description: row.querySelector('.item-description').value,
                    quantity: row.querySelector('.item-quantity').value,
                    price: row.querySelector('.item-price').value,
                    amount: row.querySelector('.item-amount').value
                });
            });
            return items;
        }

        function addItemRow(item = null) {
            const tbody = document.getElementById('item-rows');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="item-description" value="${item ? item.description : ''}"></td>
                <td><input type="number" class="item-quantity" value="${item ? item.quantity : '1'}"></td>
                <td><input type="number" class="item-price" value="${item ? item.price : '0.00'}"></td>
                <td><input type="number" class="item-amount" value="${item ? item.amount : '0.00'}" readonly></td>
            `;
            tbody.appendChild(newRow);
            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;
            const rows = document.querySelectorAll('#item-rows tr');
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const amount = quantity * price;
                row.querySelector('.item-amount').value = amount.toFixed(2);
                subtotal += amount;
            });
            document.getElementById('subtotal').value = subtotal.toFixed(2);
            document.getElementById('total').value = subtotal.toFixed(2);
        }

        // Event listeners
        document.getElementById('add-item').addEventListener('click', () => addItemRow());

        document.getElementById('items-table').addEventListener('input', (e) => {
            if (e.target.classList.contains('item-quantity') || e.target.classList.contains('item-price')) {
                updateTotals();
            }
        });

        statusFilters.forEach(button => {
            button.addEventListener('click', () => {
                statusFilters.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                renderInvoices(button.dataset.status);
            });
        });

        // Logo upload functionality
        document.getElementById('logo-upload-area').addEventListener('click', () => {
            document.getElementById('logo-upload').click();
        });

        document.getElementById('logo-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '200px';
                    document.getElementById('logo-upload-area').innerHTML = '';
                    document.getElementById('logo-upload-area').appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });

        // Set up Telegram WebApp main button
        Telegram.WebApp.MainButton.setText('Close App');
        Telegram.WebApp.MainButton.onClick(() => {
            Telegram.WebApp.close();
        });
        Telegram.WebApp.MainButton.show();

        // Initialize the app
        authorizeUser();
    </script>
</body>
</html>